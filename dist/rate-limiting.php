<?php function push_b($b) { $a = array_shift(debug_backtrace()); return $a["file"].": Line ".$a["line"].": ".$b; } if (!(file_exists("rate-limiting.conf"))) { die(push_b("No config file found! Looking for \"rate-limiting.conf\".")); } try { $c = file_get_contents("rate-limiting.conf"); } catch(Exception $f) { die(push_b("Cannot open file! Looking for \"rate-limiting.conf\". Invali permissions?")); } $c = json_decode($c, TRUE); $c = $c[0]; $d = $c["database_file_name"]; if (!(file_exists($d))) { try { fopen($d, "w"); } catch(Exception $f) { die(push_b("Database file \"$d\" could not be created! invali permissions?")); } } $m = "null"; $j = FALSE; try { $l = file_get_contents($d, LOCK_EX); if ($l != "") { $j = TRUE; } if ($j) { $m = json_decode($l, TRUE); } } catch(Exception $f) { die(push_b("Cannot open file! Looking for \"$d\". Invali permissions?")); } if (!empty($_SERVER['HTTP_CLIENT_IP'])) { $k = $_SERVER['HTTP_CLIENT_IP']; }elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) { $k = $_SERVER['HTTP_X_FORWARDED_FOR']; } else { $k = $_SERVER['REMOTE_ADDR']; } $g = array(); if ($j) { foreach ($m as $o) { $n = time() - $c["interval_time_seconds"]; if (strtotime($o["time"]) > $n) { array_push($g, $o); } } } array_push($g, array("ip" => $k, "time" => date("Y-m-d H:i:s"), "user-agent" => $_SERVER['HTTP_USER_AGENT'])); file_put_contents($d, json_encode($g)); if ($j) { foreach ($g as $i) { $e = 0; foreach ($g as $h) { if ($h["ip"] == $i["ip"] && $i["user-agent"] == $h["user-agent"]) { $e++; } } if ($e >= $c["request_allowance"]) { if ($c['die_on_rate_limit']) { die("You are being rate-limited!"); } header('Location: '.$c['redirect_location']); } } } ?>
