<?php function push_error($error) { $dbg = array_shift(debug_backtrace()); return $dbg["file"].": Line ".$dbg["line"].": ".$error; } if (!(file_exists("config.json"))) { die(push_error("No config file found! Looking for \"config.json\".")); } try { $config = file_get_contents("config.json"); } catch(Exception $f) { die(push_error("Cannot open file! Looking for \"config.json\". Invalid permissions?")); } $config = json_decode($config, TRUE); $config = $config[0]; $dbFileName = $config["database_file_name"]; if (!(file_exists($dbFileName))) { try { fopen($dbFileName, "w"); } catch(Exception $f) { die(push_error("Database file \"$dbFileName\" could not be created! invalid permissions?")); } } $db = "null"; $dbIndexable = FALSE; try { $fileBuffer = file_get_contents($dbFileName, LOCK_EX); if ($fileBuffer != "") { $dbIndexable = TRUE; } if ($dbIndexable) { $db = json_decode($fileBuffer, TRUE); } } catch(Exception $f) { die(push_error("Cannot open file! Looking for \"$dbFileName\". Invalid permissions?")); } if (!empty($_SERVER['HTTP_CLIENT_IP'])) { $ip = $_SERVER['HTTP_CLIENT_IP']; }elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])) { $ip = $_SERVER['HTTP_X_FORWARDED_FOR']; } else { $ip = $_SERVER['REMOTE_ADDR']; } $newDb = array(); if ($dbIndexable) { foreach ($db as $value) { $timeDiff = time() - $config["interval_time_seconds"]; if (strtotime($value["time"]) > $timeDiff) { array_push($newDb, $value); } } } array_push($newDb, array("ip" => $ip, "time" => date("Y-m-d H:i:s"), "user-agent" => $_SERVER['HTTP_USER_AGENT'])); file_put_contents($dbFileName, json_encode($newDb)); if ($dbIndexable) { foreach ($newDb as $id) { $hits = 0; foreach ($newDb as $id_1) { if ($id_1["ip"] == $id["ip"] && $id["user-agent"] == $id_1["user-agent"]) { $hits++; } } if ($hits >= $config["request_allowance"]) { if ($config['die_on_rate_limit']) { die("You are being rate-limited!"); } header('Location: '.$config['redirect_location']); } } } ?>
